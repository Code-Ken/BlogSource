title: TCP连接与断开的握手机制
date: 2016-03-09 11:36:12
categories: 网络协议
tags: [TCP,网络协议,握手]
---


<center>介绍TCP连接与断开的握手机制</center>

<!--more-->




## TCP连接

`三次握手机制`

![](1.png)


- 第一次
A 的 TCP 向 B 发出连接请求报文段，其首部中的同步位 SYN = 1，并选择序号 seq = x，表明传送数据时的第一个数据字节的序号是 x。
- 第二次
B 的 TCP 收到连接请求报文段后，如同意，则发回确认。
B 在确认报文段中应使 SYN = 1，使 ACK = 1，其确认号ack = x + 1，自己选择的序号 seq = y。
- 第三次
A 收到此报文段后向 B 给出确认，其 ACK = 1，确认号 ack = y + 1。
A 的 TCP 通知上层应用进程，连接已经建立。

建立了全双工通信！

## TCP关闭

`四次握手机制`

![](2.png)


- 第一次
数据传输结束后，通信的双方都可释放连接。现在 A 的应用进程先向其 TCP 发出连接释放报文段，并停止再发送数据，主动关闭TCP连接。
A把连接释放报文段首部的 FIN = 1，其序号seq = u，等待 B 的确认

- 第二次
B 发出确认，确认号 ack = u + 1，而这个报文段自己的序号 seq = v。
TCP服务器进程通知高层应用进程。
从 A 到 B 这个方向的连接就释放了，TCP 连接处于`半关闭状态`。B 若发送数据，A 仍要接收。

- 第三次
若 B 已经没有要向 A 发送的数据，其应用进程就通知 TCP 释放连接。

- 第四次
A 收到连接释放报文段后，必须发出确认。 
在确认报文段中 ACK = 1，确认号 ack = w + 1，自己的序号 seq = u。 

